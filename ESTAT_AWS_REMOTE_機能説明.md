# estat-aws-remote でできること

## 📌 概要

**estat-aws-remote** は、日本政府の統計データポータル「e-Stat」のデータを、自然言語で検索・取得・分析できるツールです。AWS上で動作し、大規模データの処理にも対応しています。

---

## 🎯 主な機能（全12ツール）

### 1️⃣ データ検索

#### 🔍 自然言語でデータを探す
**できること:**
- 「東京都の交通事故統計」「年齢別 収入」など、普通の言葉で検索
- AIが自動的に最適なデータセットを提案
- キーワードの言い換え提案（例: "収入" → "所得"）

**使い方の例:**
```
「北海道の人口統計を探して」
「京都府の労働力データを検索」
```

---

### 2️⃣ データ取得

#### 📥 データを自動で取得
**できること:**
- データサイズを自動判定して最適な方法で取得
- 小規模データ（10万件未満）→ 一括取得
- 大規模データ（10万件以上）→ 分割取得
- 取得したデータは自動的にAWS S3に保存

**使い方の例:**
```
「データセットID 0002070001 を取得して」
```

#### 🎯 条件を指定して絞り込み取得
**できること:**
- 地域、年度、カテゴリなどで絞り込み
- 大規模データから必要な部分だけを効率的に取得

**使い方の例:**
```
「東京都（地域コード: 13000）の2020年のデータだけ取得」
```

---

### 3️⃣ CSV変換・ダウンロード

#### 💾 ExcelやGoogleスプレッドシートで使えるCSV形式に変換
**できること:**
- 取得したデータをCSV形式に変換
- BOM付きUTF-8で保存（Excelで文字化けしない）
- AWS S3に自動保存

**使い方の例:**
```
「取得したデータをCSVに変換して」
```

#### 🔗 統計表のホームページリンクを取得
**できること:**
- 統計表IDからe-Statのホームページリンクを生成
- ブラウザで統計表の詳細情報を確認できる
- データの出典確認や詳細な説明を見るのに便利

**使い方の例:**
```
「統計表ID 0002112323 のリンクを教えて」
→ https://www.e-stat.go.jp/dbview?sid=0002112323
```

#### ⬇️ CSVファイルをダウンロード
**できること:**
- S3に保存されたCSVファイルをローカルにダウンロード
- ブラウザで開けるダウンロードURLを生成（有効期限付き）

**使い方の例:**
```
「CSVファイルをダウンロードして」
「ダウンロードリンクを作成して」
```

---

### 4️⃣ データ変換・分析

#### 🔄 高速分析用のParquet形式に変換
**できること:**
- JSONデータを高速分析用のParquet形式に変換
- データサイズを大幅に削減（通常50-80%削減）

#### 🗄️ データベースに保存
**できること:**
- ParquetデータをAthena（データベース）に保存
- SQLで自由に分析できる状態にする

#### 📊 統計分析を実行
**できること:**
- 基本統計（平均、最大、最小、合計など）
- 年別・地域別・カテゴリ別の集計
- 時系列トレンド分析

**使い方の例:**
```
「このデータの基本統計を出して」
「年別の推移を分析して」
```

---

## 🌟 典型的な使い方の流れ

### パターン1: データを探してExcelで使う

```
1. 「北海道の人口統計を探して」
   → AIが最適なデータセットを提案

2. 「データセットID 0003458339 を取得して」
   → データを自動取得してS3に保存

3. 「CSVに変換して」
   → Excel/Googleスプレッドシートで使えるCSV形式に変換

4. 「ダウンロードリンクを作成して」
   → ブラウザで開けるリンクを生成
```

### パターン2: 大規模データを分析する

```
1. 「全国の事業所統計を探して」
   → AIが最適なデータセットを提案

2. 「データセットを取得して」
   → 大規模データを自動的に分割取得

3. 「Parquet形式に変換して」
   → 高速分析用の形式に変換

4. 「データベースに保存して」
   → Athenaデータベースに投入

5. 「基本統計を出して」
   → SQLで自動分析
```

---

## 💡 便利な機能

### ✨ 自動キーワード変換
- 「収入」→「所得」
- 「会社」→「事業所」
- 「お年寄り」→「高齢者」

など、e-Statで使われている正式な用語に自動変換を提案します。

### 🚀 大規模データ対応
- 100万件以上のデータも自動的に分割して取得
- タイムアウトを回避する仕組み

### 📈 メタデータ表示
- データの総件数
- 利用可能なカテゴリ（地域、年度など）
- データの更新日

---

## 🔧 技術的な特徴

### AWS統合
- **S3**: データの永続化保存
- **Athena**: SQL分析エンジン
- **ECS Fargate**: サーバーレス実行環境

### データ形式
- **入力**: e-Stat API（JSON）
- **中間**: Parquet（高速分析用）
- **出力**: CSV（Excel互換）、Iceberg（データベース）

### パフォーマンス
- 並列処理による高速化
- コネクションプーリング
- 自動リトライ機能

---

## 📝 利用可能なツール一覧

| No | ツール名 | 機能 |
|----|---------|------|
| 1 | `search_estat_data` | 自然言語でデータ検索 |
| 2 | `apply_keyword_suggestions` | キーワード変換を適用 |
| 3 | `fetch_dataset_auto` | データ自動取得 |
| 4 | `fetch_large_dataset_complete` | 大規模データ完全取得 |
| 5 | `fetch_dataset_filtered` | 条件絞り込み取得 |
| 6 | `save_dataset_as_csv` | CSV形式で保存 |
| 7 | `get_estat_table_url` | 統計表ホームページリンク生成 |
| 8 | `get_csv_download_url` | ダウンロードURL生成 |
| 9 | `download_csv_from_s3` | CSVダウンロード |
| 10 | `transform_to_parquet` | Parquet形式に変換 |
| 11 | `load_to_iceberg` | データベースに投入 |
| 12 | `analyze_with_athena` | 統計分析実行 |

---

## 🎓 使い方のコツ

### 検索のコツ
- 具体的なキーワードを使う（「統計」より「人口統計」）
- 地域名を入れる（「東京都」「北海道」など）
- 年度を指定する（「2020年」「令和2年」など）

### データ取得のコツ
- 小さいデータ（10万件未満）→ `fetch_dataset_auto`
- 大きいデータ（10万件以上）→ `fetch_large_dataset_complete` または `fetch_dataset_filtered`
- 特定の地域・年度だけ欲しい → `fetch_dataset_filtered`

### CSV変換のコツ
- データ取得後、すぐにCSV変換すると効率的
- ダウンロードURLは1時間有効（必要に応じて延長可能）

---

## ⚠️ 注意事項

### データサイズ
- 100万件以上のデータは分割取得が必要
- CSVファイルが大きい場合、メモリ使用量に注意

### AWS認証
- AWS認証情報（アクセスキー）が必要
- S3バケット `estat-data-lake` へのアクセス権限が必要

### API制限
- e-Stat APIにはレート制限があります
- 大量のリクエストを短時間に送ると制限される可能性

---

## 🆘 困ったときは

### データが見つからない
→ キーワードを変えて再検索してみてください

### データ取得が失敗する
→ データサイズが大きい場合、`fetch_dataset_filtered`で絞り込んでください

### CSVダウンロードができない
→ ダウンロードURLの有効期限（1時間）が切れていないか確認してください

---

## 📚 関連ドキュメント

- 詳細な技術仕様: `README_MCP_TOOLS.md`
- セットアップガイド: `ESTAT_AWS_SETUP_GUIDE.md`
- デプロイ手順: `ESTAT_AWS_DEPLOYMENT_SUMMARY.md`

---

**作成日**: 2026年1月14日  
**バージョン**: v2.1.0
