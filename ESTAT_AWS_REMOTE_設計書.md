# estat-aws-remote ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## ðŸ“‹ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°](#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°)
4. [é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«](#é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«)
5. [AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£](#awsã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£)
6. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
7. [é‹ç”¨ç®¡ç†](#é‹ç”¨ç®¡ç†)
8. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹)

---

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
**estat-aws-remote** - e-Statçµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ»å–å¾—ãƒ»åˆ†æžã‚·ã‚¹ãƒ†ãƒ 

### ç›®çš„
æ—¥æœ¬æ”¿åºœçµ±è¨ˆãƒãƒ¼ã‚¿ãƒ«ï¼ˆe-Statï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªç„¶è¨€èªžã§æ¤œç´¢ã—ã€AWSä¸Šã§å–å¾—ãƒ»å¤‰æ›ãƒ»åˆ†æžã‚’è¡Œã†MCPã‚µãƒ¼ãƒãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã€‚

### ä¸»è¦æ©Ÿèƒ½
1. **è‡ªç„¶è¨€èªžæ¤œç´¢**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ä»˜ããƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ¤œç´¢
2. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: å°è¦æ¨¡ï½žå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•åˆ¤å®šãƒ»å–å¾—
3. **ãƒ‡ãƒ¼ã‚¿å¤‰æ›**: JSON â†’ CSV/Parquetå½¢å¼ã¸ã®å¤‰æ›
4. **ãƒ‡ãƒ¼ã‚¿åˆ†æž**: Athena Icebergãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®çµ±è¨ˆåˆ†æž
5. **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: ç½²åä»˜ãURLç”Ÿæˆã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³
- **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v2.3.0
- **æœ€çµ‚æ›´æ–°æ—¥**: 2026å¹´1æœˆ16æ—¥

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kiro IDE (Client)                        â”‚
â”‚                    MCP Client (streamable-http)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTPS
                             â”‚ (streamable-http protocol)
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AWS Application Load Balancer                 â”‚
â”‚              https://estat-mcp.snowmole.co.jp/mcp               â”‚
â”‚                    (SSL/TLS Termination)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP
                             â”‚ (Internal VPC)
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AWS ECS Fargate Cluster                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ECS Task (estat-mcp-task)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚         server_mcp_streamable.py                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (MCP Streamable HTTP Server)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - GET /mcp  â†’ SSE Stream                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - POST /mcp â†’ JSON-RPC 2.0                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - DELETE /mcp â†’ Session Termination               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                     â”‚                                      â”‚  â”‚
â”‚  â”‚                     â†“                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚    mcp_servers/estat_aws/server.py                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚         (EStatAWSServer)                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - 11å€‹ã®ãƒ„ãƒ¼ãƒ«å®Ÿè£…                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - e-Stat APIé€£æº                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - AWS SDK (boto3) çµ±åˆ                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        External Services                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   e-Stat API     â”‚  â”‚   AWS S3         â”‚  â”‚  AWS Athena   â”‚  â”‚
â”‚  â”‚  (çµ±è¨ˆãƒ‡ãƒ¼ã‚¿)     â”‚  â”‚  (ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯)   â”‚  â”‚  (åˆ†æžã‚¨ãƒ³ã‚¸ãƒ³)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç‰¹å¾´

#### 1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼åˆ†é›¢
- **Kiro IDE**: MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦å‹•ä½œ
- **AWS ECS Fargate**: MCPã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å‹•ä½œ
- **é€šä¿¡**: HTTPS (streamable-http protocol)

#### 2. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªã‚¤ãƒ³ãƒ•ãƒ©
- **ECS Fargate**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œç’°å¢ƒ
- **ALB**: è² è·åˆ†æ•£ã¨SSL/TLSçµ‚ç«¯
- **Auto Scaling**: ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«å¿œã˜ãŸè‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

#### 3. ã‚»ã‚­ãƒ¥ã‚¢ãªé€šä¿¡
- **HTTPS**: å…¨é€šä¿¡ã®æš—å·åŒ–
- **ALB**: SSL/TLSè¨¼æ˜Žæ›¸ç®¡ç†
- **VPC**: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§ã®é€šä¿¡

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### 1. server_mcp_streamable.py

**å½¹å‰²**: MCP Streamable HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®Ÿè£…

**ä¸»è¦æ©Ÿèƒ½**:
- MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æä¾›
- JSON-RPC 2.0ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
- SSEã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ç®¡ç†
- ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã®å§”è­²

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | ç”¨é€” |
|---------|------|------|
| GET | /mcp | SSEã‚¹ãƒˆãƒªãƒ¼ãƒ é–‹å§‹ |
| POST | /mcp | JSON-RPCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† |
| DELETE | /mcp | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† |
| GET | /health | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |
| GET | / | ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ± |

**å®Ÿè£…è©³ç´°**:

```python
# MCPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
async def handle_mcp_endpoint(request):
    method = request.method
    
    if method == 'GET':
        # SSEã‚¹ãƒˆãƒªãƒ¼ãƒ é–‹å§‹
        if 'text/event-stream' in request.headers.get('Accept', ''):
            return await handle_sse_stream(request)
    
    elif method == 'POST':
        # JSON-RPCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
        data = await request.json()
        response_data = await handle_jsonrpc_message(data)
        return web.json_response(response_data)
    
    elif method == 'DELETE':
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
        return web.Response(status=200, text="Session terminated")
```

**JSON-RPCãƒ¡ã‚½ãƒƒãƒ‰**:

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜Ž |
|---------|------|
| initialize | MCPã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ– |
| tools/list | åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ä¸€è¦§å–å¾— |
| tools/call | ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ |

**ãƒ„ãƒ¼ãƒ«ãƒžãƒƒãƒ”ãƒ³ã‚°**:

```python
TOOLS = {
    "search_estat_data": {
        "handler": lambda **kwargs: estat_server.search_estat_data(**kwargs),
        "description": "è‡ªç„¶è¨€èªžã§e-Statãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢",
        "parameters": {...}
    },
    # ... å…¨11ãƒ„ãƒ¼ãƒ«
}
```

### 2. mcp_servers/estat_aws/server.py

**å½¹å‰²**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

**ã‚¯ãƒ©ã‚¹**: `EStatAWSServer`

**åˆæœŸåŒ–**:

```python
class EStatAWSServer:
    def __init__(self):
        self.app_id = ESTAT_APP_ID
        self.base_url = "https://api.e-stat.go.jp/rest/3.0/app/json"
        
        # HTTPã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°ï¼‰
        self.session = requests.Session()
        
        # AWSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        self.s3_client = boto3.client('s3', region_name=AWS_REGION)
        self.athena_client = boto3.client('athena', region_name=AWS_REGION)
```

**å®Ÿè£…ãƒ„ãƒ¼ãƒ«** (å…¨12å€‹):

1. **search_estat_data** - è‡ªç„¶è¨€èªžæ¤œç´¢
2. **apply_keyword_suggestions** - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¤‰æ›é©ç”¨
3. **fetch_dataset_auto** - è‡ªå‹•ãƒ‡ãƒ¼ã‚¿å–å¾—
4. **fetch_large_dataset_complete** - å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å–å¾—
5. **fetch_dataset_filtered** - ãƒ•ã‚£ãƒ«ã‚¿ä»˜ããƒ‡ãƒ¼ã‚¿å–å¾—
6. **save_dataset_as_csv** - CSVä¿å­˜
7. **save_metadata_as_csv** - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿CSVä¿å­˜
8. **get_csv_download_url** - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLç”Ÿæˆ
9. **get_estat_table_url** - e-Statãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URLç”Ÿæˆ
10. **transform_to_parquet** - Parquetå¤‰æ›
11. **load_to_iceberg** - Icebergãƒ†ãƒ¼ãƒ–ãƒ«æŠ•å…¥
12. **analyze_with_athena** - Athenaåˆ†æž

**ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰**:

```python
# e-Stat APIå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
@retry_with_backoff(max_retries=3, base_delay=1.0)
async def _call_estat_api(self, endpoint: str, params: Dict[str, Any])

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿é«˜é€Ÿå–å¾—
async def _get_metadata_quick(self, dataset_id: str)

# Athenaã‚¯ã‚¨ãƒªå®Ÿè¡Œ
async def _execute_athena_query(self, query: str, database: str, output_location: str)
```

### 3. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### keyword_dictionary.py

**å½¹å‰²**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½

**ä¸»è¦é–¢æ•°**:
- `get_keyword_suggestions(query)` - ã‚¯ã‚¨ãƒªã‹ã‚‰ã‚µã‚¸ã‚§ã‚¹ãƒˆç”Ÿæˆ
- `apply_keyword_suggestions(query, accepted)` - å¤‰æ›é©ç”¨
- `format_suggestion_message(suggestions)` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¾žæ›¸ä¾‹**:
```python
KEYWORD_DICTIONARY = {
    "åŽå…¥": ["æ‰€å¾—", "åŽå…¥"],
    "ä¼šç¤¾": ["äº‹æ¥­æ‰€", "ä¼æ¥­"],
    "å¹´é½¢": ["å¹´é½¢éšŽç´š", "å¹´é½¢å±¤"],
    # ... ç´„50å€‹ã®ãƒžãƒƒãƒ”ãƒ³ã‚°
}
```

#### utils/error_handler.py

**å½¹å‰²**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

**ä¸»è¦é–¢æ•°**:
- `format_error_response(error, tool_name, context)` - ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹: `EStatError`, `AWSError`, `DataTransformError`

#### utils/retry.py

**å½¹å‰²**: ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

**ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿**:
```python
@retry_with_backoff(max_retries=3, base_delay=1.0)
async def api_call():
    # ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å†è©¦è¡Œ
    pass
```

#### utils/logger.py

**å½¹å‰²**: ãƒ­ã‚®ãƒ³ã‚°

**ä¸»è¦é–¢æ•°**:
- `setup_logger(name, level)` - ãƒ­ã‚¬ãƒ¼è¨­å®š
- `log_tool_call(logger, tool_name, params)` - ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ãƒ­ã‚°
- `log_tool_result(logger, tool_name, success, time)` - å®Ÿè¡Œçµæžœãƒ­ã‚°

#### utils/response_formatter.py

**å½¹å‰²**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

**ä¸»è¦é–¢æ•°**:
- `format_success_response(data)` - æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
- `format_dataset_info(table, rank, score)` - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæƒ…å ±ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

---

## é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### MCP Streamable HTTP Protocol

**ä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2024-11-05

#### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹ (GET /mcp)

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```http
GET /mcp HTTP/1.1
Host: estat-mcp.snowmole.co.jp
Accept: text/event-stream
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```http
HTTP/1.1 200 OK
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive

event: connection
data: {"status": "ready", "timestamp": "2026-01-16T10:30:00Z"}

```

**ç‰¹å¾´**:
- Server-Sent Events (SSE) ã«ã‚ˆã‚‹åŒæ–¹å‘é€šä¿¡
- æŽ¥ç¶šç¢ºç«‹æ™‚ã«å³åº§ã®åˆæœŸåŒ–ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- ãƒŽãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã§æŽ¥ç¶šç¶­æŒï¼ˆãƒãƒ³ã‚°é˜²æ­¢ï¼‰

#### 2. JSON-RPC ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (POST /mcp)

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ (initialize)**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {
      "name": "kiro",
      "version": "1.0.0"
    }
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "tools": {}
    },
    "serverInfo": {
      "name": "estat-aws",
      "version": "1.0.0"
    }
  }
}
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ (tools/list)**:
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/list",
  "params": {}
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "tools": [
      {
        "name": "search_estat_data",
        "description": "è‡ªç„¶è¨€èªžã§e-Statãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ä»˜ãã§æœ€é©ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ææ¡ˆ",
        "inputSchema": {
          "type": "object",
          "properties": {
            "query": {"type": "string"},
            "max_results": {"type": "integer"},
            "auto_suggest": {"type": "boolean"},
            "scoring_method": {"type": "string"}
          },
          "required": ["query"]
        }
      }
      // ... å…¨11ãƒ„ãƒ¼ãƒ«
    ]
  }
}
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ (tools/call)**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "search_estat_data",
    "arguments": {
      "query": "åŒ—æµ·é“ äººå£",
      "max_results": 5
    }
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"success\": true, \"query\": \"åŒ—æµ·é“ äººå£\", ...}"
      }
    ]
  }
}
```

#### 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† (DELETE /mcp)

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```http
DELETE /mcp HTTP/1.1
Host: estat-mcp.snowmole.co.jp
Mcp-Session-Id: session-12345
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```http
HTTP/1.1 200 OK

Session terminated
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**JSON-RPCã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:

| ã‚³ãƒ¼ãƒ‰ | æ„å‘³ | èª¬æ˜Ž |
|-------|------|------|
| -32700 | Parse error | ä¸æ­£ãªJSON |
| -32600 | Invalid Request | ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ |
| -32601 | Method not found | ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„ |
| -32602 | Invalid params | ä¸æ­£ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
| -32603 | Internal error | å†…éƒ¨ã‚¨ãƒ©ãƒ¼ |

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "error": {
    "code": -32601,
    "message": "Tool not found: invalid_tool"
  }
}
```

---

## AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

### 1. Application Load Balancer (ALB)

**å½¹å‰²**: 
- SSL/TLSçµ‚ç«¯
- HTTPSãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å—ä¿¡
- ECS Fargateã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**è¨­å®š**:
- **ãƒªã‚¹ãƒŠãƒ¼**: HTTPS (443)
- **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—**: ECS Fargateã‚¿ã‚¹ã‚¯
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: GET /health
- **SSLè¨¼æ˜Žæ›¸**: AWS Certificate Manager (ACM)

**ãƒ‰ãƒ¡ã‚¤ãƒ³**: `estat-mcp.snowmole.co.jp`

### 2. ECS Fargate

**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼**: `estat-mcp-cluster`

**ã‚µãƒ¼ãƒ“ã‚¹**: `estat-mcp-service`
- **ã‚¿ã‚¹ã‚¯å®šç¾©**: `estat-mcp-task`
- **CPU**: 1024 (1 vCPU)
- **ãƒ¡ãƒ¢ãƒª**: 2048 MB (2 GB)
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰**: awsvpc

**ã‚¿ã‚¹ã‚¯å®šç¾©**:
```json
{
  "family": "estat-mcp-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "1024",
  "memory": "2048",
  "containerDefinitions": [
    {
      "name": "estat-mcp-container",
      "image": "YOUR_ECR_REPO/estat-mcp:latest",
      "portMappings": [
        {
          "containerPort": 8080,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {"name": "ESTAT_APP_ID", "value": "..."},
        {"name": "S3_BUCKET", "value": "estat-data-lake"},
        {"name": "AWS_REGION", "value": "ap-northeast-1"}
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/estat-mcp",
          "awslogs-region": "ap-northeast-1",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
```

**Auto Scaling**:
- **æœ€å°ã‚¿ã‚¹ã‚¯æ•°**: 1
- **æœ€å¤§ã‚¿ã‚¹ã‚¯æ•°**: 10
- **ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼**: CPUä½¿ç”¨çŽ‡ > 70%

### 3. Amazon S3

**ãƒã‚±ãƒƒãƒˆ**: `estat-data-lake`

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ **:
```
estat-data-lake/
â”œâ”€â”€ raw/
â”‚   â””â”€â”€ data/              # ç”ŸJSONãƒ‡ãƒ¼ã‚¿
â”‚       â”œâ”€â”€ {dataset_id}_{timestamp}.json
â”‚       â””â”€â”€ {dataset_id}_chunk_001_{timestamp}.json
â”œâ”€â”€ processed/             # Parquetãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ {dataset_id}_{timestamp}.parquet
â”œâ”€â”€ csv/                   # CSVãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ {dataset_id}_{timestamp}.csv
â”‚   â””â”€â”€ {dataset_id}_metadata_{timestamp}.csv
â”œâ”€â”€ iceberg-tables/        # Icebergãƒ†ãƒ¼ãƒ–ãƒ«
â”‚   â””â”€â”€ {table_name}/
â””â”€â”€ athena-results/        # Athenaã‚¯ã‚¨ãƒªçµæžœ
    â””â”€â”€ {query_id}/
```

**ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼**:
- ECS Fargateã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‹ã‚‰ã®èª­ã¿æ›¸ãè¨±å¯
- Athenaã‹ã‚‰ã®èª­ã¿å–ã‚Šè¨±å¯

### 4. Amazon Athena

**ãƒ¯ãƒ¼ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—**: `estat-mcp-workgroup`

**è¨­å®š**:
- **å‡ºåŠ›å ´æ‰€**: `s3://estat-data-lake/athena-results/`
- **ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°**: AWS Glue Data Catalog
- **ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 60ç§’

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: `estat_db`

**ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼**: Apache Iceberg
- **ACIDä¿è¨¼**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œ
- **ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«**: éŽåŽ»ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‚ç…§
- **ã‚¹ã‚­ãƒ¼ãƒžé€²åŒ–**: ã‚«ãƒ©ãƒ è¿½åŠ ãƒ»å‰Šé™¤ãŒå®¹æ˜“

### 5. AWS Glue Data Catalog

**å½¹å‰²**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: `estat_db`

**ãƒ†ãƒ¼ãƒ–ãƒ«ä¾‹**:
```sql
CREATE TABLE estat_db.population_data (
    stats_data_id STRING,
    year INT,
    region_code STRING,
    category STRING,
    value DOUBLE,
    unit STRING,
    updated_at TIMESTAMP
)
LOCATION 's3://estat-data-lake/iceberg-tables/population_data/'
TBLPROPERTIES (
    'table_type'='ICEBERG',
    'format'='parquet'
)
```

### 6. IAM ãƒ­ãƒ¼ãƒ«

**ECS Task Execution Role**:
- ECRã‹ã‚‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒ«
- CloudWatch Logsã¸ã®æ›¸ãè¾¼ã¿

**ECS Task Role**:
- S3ã¸ã®èª­ã¿æ›¸ã
- Athenaã‚¯ã‚¨ãƒªå®Ÿè¡Œ
- Glue Data Catalogã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

**ãƒãƒªã‚·ãƒ¼ä¾‹**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::estat-data-lake",
        "arn:aws:s3:::estat-data-lake/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "athena:StartQueryExecution",
        "athena:GetQueryExecution",
        "athena:GetQueryResults"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "glue:GetDatabase",
        "glue:GetTable",
        "glue:CreateTable",
        "glue:UpdateTable"
      ],
      "Resource": "*"
    }
  ]
}
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 1. é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**HTTPSé€šä¿¡**:
- å…¨é€šä¿¡ã‚’TLS 1.2ä»¥ä¸Šã§æš—å·åŒ–
- ALBã§SSL/TLSçµ‚ç«¯
- ACMç®¡ç†ã®SSLè¨¼æ˜Žæ›¸ä½¿ç”¨

**VPCå†…é€šä¿¡**:
- ALB â†’ ECS Fargateé–“ã¯HTTP (VPCå†…éƒ¨)
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§é€šä¿¡åˆ¶é™

### 2. èªè¨¼ãƒ»èªå¯

**ç¾åœ¨ã®å®Ÿè£…**:
- èªè¨¼ãªã—ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‰æï¼‰

**å°†æ¥ã®æ‹¡å¼µ**:
- API Keyèªè¨¼
- OAuth 2.0
- IAMèªè¨¼

### 3. ãƒ‡ãƒ¼ã‚¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**S3ãƒã‚±ãƒƒãƒˆ**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæš—å·åŒ–æœ‰åŠ¹ (SSE-S3)
- ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹
- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯

**ç½²åä»˜ãURL**:
- æœ‰åŠ¹æœŸé™ä»˜ã (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“)
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å°‚ç”¨
- æ”¹ã–ã‚“é˜²æ­¢

### 4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**:
- ALB: ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ 443 (HTTPS) ã®ã¿è¨±å¯
- ECS Fargate: ALBã‹ã‚‰ã® 8080 ã®ã¿è¨±å¯
- ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰: å¿…è¦æœ€å°é™

**VPCè¨­å®š**:
- ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆå†…ã§ECSå®Ÿè¡Œ
- NATã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤çµŒç”±ã§å¤–éƒ¨APIæŽ¥ç¶š

---

## é‹ç”¨ç®¡ç†

### 1. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

**CloudWatch Logs**:
- ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ : `/ecs/estat-mcp`
- ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«: INFO (ç’°å¢ƒå¤‰æ•°ã§å¤‰æ›´å¯èƒ½)
- ãƒ­ã‚°ä¿æŒæœŸé–“: 30æ—¥

**ãƒ­ã‚°å‡ºåŠ›ä¾‹**:
```
[2026-01-16 10:30:15] Starting e-Stat AWS MCP Server (Streamable HTTP)
[2026-01-16 10:30:15] Host: 0.0.0.0:8080
[2026-01-16 10:30:15] e-Stat AWS Server initialized successfully
[2026-01-16 10:30:20] MCP Request: POST from 10.0.1.50
[2026-01-16 10:30:20] JSONRPC Request: method=tools/call, id=3
[2026-01-16 10:30:20] Processing tools/call request: search_estat_data
[2026-01-16 10:30:22] Tool execution completed successfully: search_estat_data
```

**CloudWatch Metrics**:
- CPUä½¿ç”¨çŽ‡
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŽ‡
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
- ã‚¨ãƒ©ãƒ¼çŽ‡

**ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®š**:
- CPUä½¿ç”¨çŽ‡ > 80%
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŽ‡ > 85%
- ã‚¨ãƒ©ãƒ¼çŽ‡ > 5%
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—

### 2. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

**CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**:
```bash
# 1. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker build -t estat-mcp:latest .

# 2. ECRã«ãƒ—ãƒƒã‚·ãƒ¥
aws ecr get-login-password | docker login --username AWS --password-stdin
docker tag estat-mcp:latest YOUR_ECR_REPO/estat-mcp:latest
docker push YOUR_ECR_REPO/estat-mcp:latest

# 3. ECSã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°
aws ecs update-service \
  --cluster estat-mcp-cluster \
  --service estat-mcp-service \
  --force-new-deployment
```

**ãƒ–ãƒ«ãƒ¼/ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ**:
- æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é€šéŽå¾Œã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ
- æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢

### 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

**S3ãƒ‡ãƒ¼ã‚¿**:
- ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹
- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼:
  - 30æ—¥å¾Œã«Glacierã¸ç§»è¡Œ
  - 365æ—¥å¾Œã«å‰Šé™¤

**Glue Data Catalog**:
- å®šæœŸçš„ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### 4. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

**æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**:
- Auto Scalingã«ã‚ˆã‚‹è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½è·¡ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼
- ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ: CPU > 70%
- ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³: CPU < 30%

**åž‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**:
- ã‚¿ã‚¹ã‚¯å®šç¾©ã®CPU/ãƒ¡ãƒ¢ãƒªå¤‰æ›´
- ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ã§æ®µéšŽçš„ã«ç§»è¡Œ

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹

### 1. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 

**ãƒ„ãƒ¼ãƒ«åˆ¥å¹³å‡å®Ÿè¡Œæ™‚é–“**:

| ãƒ„ãƒ¼ãƒ« | å¹³å‡æ™‚é–“ | å‚™è€ƒ |
|-------|---------|------|
| search_estat_data | 2-5ç§’ | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¸¦åˆ—å–å¾— |
| fetch_dataset_auto | 2-10ç§’ | ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºä¾å­˜ |
| fetch_large_dataset_complete | 8-15ç§’ | æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®ã¿ |
| fetch_dataset_filtered | 3-8ç§’ | ãƒ•ã‚£ãƒ«ã‚¿åŠ¹æžœä¾å­˜ |
| save_dataset_as_csv | 1-3ç§’ | ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºä¾å­˜ |
| transform_to_parquet | 2-5ç§’ | ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºä¾å­˜ |
| load_to_iceberg | 10-30ç§’ | Athenaã‚¯ã‚¨ãƒªå®Ÿè¡Œ |
| analyze_with_athena | 5-15ç§’ | ã‚¯ã‚¨ãƒªè¤‡é›‘åº¦ä¾å­˜ |

### 2. ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ

**åŒæ™‚æŽ¥ç¶šæ•°**: æœ€å¤§100æŽ¥ç¶š (Auto Scalingæœ‰åŠ¹æ™‚)

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†èƒ½åŠ›**: ç´„10-20 req/sec (ã‚¿ã‚¹ã‚¯1å€‹ã‚ãŸã‚Š)

### 3. æœ€é©åŒ–

**HTTPã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°**:
```python
self.session = requests.Session()
adapter = requests.adapters.HTTPAdapter(
    pool_connections=10,
    pool_maxsize=20,
    max_retries=3
)
self.session.mount('https://', adapter)
```

**éžåŒæœŸå‡¦ç†**:
- asyncioä½¿ç”¨
- ä¸¦åˆ—ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
- ãƒŽãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°I/O

**ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**:
- HTTPã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°
- å°†æ¥: Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥å°Žå…¥äºˆå®š

---

## è¨­å®š

### ç’°å¢ƒå¤‰æ•°

| å¤‰æ•°å | èª¬æ˜Ž | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|-------|------|------------|
| ESTAT_APP_ID | e-Stat APIã‚­ãƒ¼ | (å¿…é ˆ) |
| S3_BUCKET | S3ãƒã‚±ãƒƒãƒˆå | estat-data-lake |
| AWS_REGION | AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ | ap-northeast-1 |
| PORT | ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆ | 8080 |
| TRANSPORT_HOST | ãƒã‚¤ãƒ³ãƒ‰ãƒ›ã‚¹ãƒˆ | 0.0.0.0 |
| LOG_LEVEL | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« | INFO |

### Kiroè¨­å®š (.kiro/settings/mcp.json)

```json
{
  "mcpServers": {
    "estat-aws-remote": {
      "transport": "streamable-http",
      "url": "https://estat-mcp.snowmole.co.jp/mcp",
      "disabled": false,
      "autoApprove": [
        "search_estat_data",
        "apply_keyword_suggestions",
        "fetch_dataset_auto",
        "fetch_large_dataset_complete",
        "fetch_dataset_filtered",
        "transform_to_parquet",
        "load_to_iceberg",
        "analyze_with_athena",
        "save_dataset_as_csv",
        "save_metadata_as_csv",
        "get_csv_download_url",
        "get_estat_table_url"
      ]
    }
  }
}
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. æŽ¥ç¶šã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: Kiroã‹ã‚‰æŽ¥ç¶šã§ããªã„

**åŽŸå› ã¨å¯¾å‡¦**:
- ALBã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— â†’ ECSã‚¿ã‚¹ã‚¯ãƒ­ã‚°ç¢ºèª
- SSLè¨¼æ˜Žæ›¸ã®å•é¡Œ â†’ ACMè¨¼æ˜Žæ›¸ã®æœ‰åŠ¹æ€§ç¢ºèª
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š â†’ ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ç¢ºèª

### 2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: ãƒ„ãƒ¼ãƒ«å®Ÿè¡ŒãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**åŽŸå› ã¨å¯¾å‡¦**:
- å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ `fetch_dataset_filtered`ä½¿ç”¨
- Athenaã‚¯ã‚¨ãƒªé…å»¶ â†’ ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¿½åŠ 
- e-Stat APIé…å»¶ â†’ ãƒªãƒˆãƒ©ã‚¤è¨­å®šç¢ºèª

### 3. ãƒ¡ãƒ¢ãƒªä¸è¶³

**ç—‡çŠ¶**: ECSã‚¿ã‚¹ã‚¯ãŒOOM Killedã§åœæ­¢

**åŽŸå› ã¨å¯¾å‡¦**:
- å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å‡¦ç† â†’ ã‚¿ã‚¹ã‚¯å®šç¾©ã®ãƒ¡ãƒ¢ãƒªå¢—åŠ 
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ â†’ ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã€ã‚¿ã‚¹ã‚¯å†èµ·å‹•

### 4. S3ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: S3ã¸ã®ä¿å­˜/èª­ã¿è¾¼ã¿å¤±æ•—

**åŽŸå› ã¨å¯¾å‡¦**:
- IAMãƒ­ãƒ¼ãƒ«æ¨©é™ä¸è¶³ â†’ ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒãƒªã‚·ãƒ¼ç¢ºèª
- ãƒã‚±ãƒƒãƒˆåèª¤ã‚Š â†’ ç’°å¢ƒå¤‰æ•°ç¢ºèª
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ â†’ AWS_REGIONç¢ºèª

---

## ä»Šå¾Œã®æ‹¡å¼µè¨ˆç”»

### çŸ­æœŸ (1-3ãƒ¶æœˆ)

1. **èªè¨¼æ©Ÿèƒ½è¿½åŠ **
   - API Keyèªè¨¼
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°å°Žå…¥**
   - Redisçµ±åˆ
   - æ¤œç´¢çµæžœã‚­ãƒ£ãƒƒã‚·ãƒ¥

3. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å¼·åŒ–**
   - ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹ç¯‰

### ä¸­æœŸ (3-6ãƒ¶æœˆ)

1. **ãƒžãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ**
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿
   - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

2. **ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è‡ªå‹•åŒ–**
   - Step Functionsçµ±åˆ
   - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ

3. **æ©Ÿæ¢°å­¦ç¿’çµ±åˆ**
   - SageMakeré€£æº
   - äºˆæ¸¬åˆ†æžæ©Ÿèƒ½

### é•·æœŸ (6-12ãƒ¶æœˆ)

1. **GraphQL APIè¿½åŠ **
   - ã‚ˆã‚ŠæŸ”è»Ÿãªã‚¯ã‚¨ãƒª
   - ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¯¾å¿œ

2. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æž**
   - Kinesisçµ±åˆ
   - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†

3. **ãƒžãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ**
   - çµ„ç¹”åˆ¥ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
   - èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ

---

## å‚è€ƒè³‡æ–™

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [MCP Protocol Specification](https://spec.modelcontextprotocol.io/)
- [e-Stat APIä»•æ§˜æ›¸](https://www.e-stat.go.jp/api/)
- [AWS ECS Fargate](https://docs.aws.amazon.com/ecs/latest/developerguide/AWS_Fargate.html)
- [Apache Iceberg](https://iceberg.apache.org/)

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ESTAT_AWS_TOOLS_è©³ç´°è¨­è¨ˆæ›¸.md](./ESTAT_AWS_TOOLS_è©³ç´°è¨­è¨ˆæ›¸.md) - å…¨11ãƒ„ãƒ¼ãƒ«ã®è©³ç´°ä»•æ§˜
- [ECS_DEPLOYMENT_SUCCESS_V2.2.0.md](./ECS_DEPLOYMENT_SUCCESS_V2.2.0.md) - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †
- [ATHENA_FIX_COMPLETE_REPORT.md](./ATHENA_FIX_COMPLETE_REPORT.md) - Athenaä¿®æ­£å±¥æ­´

---

## å¤‰æ›´å±¥æ­´

### v2.3.0 (2026å¹´1æœˆ16æ—¥)

**ãƒ„ãƒ¼ãƒ«æ§‹æˆã®ä¿®æ­£**:
- `get_estat_table_url`ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ï¼ˆçµ±è¨ˆè¡¨IDã‹ã‚‰e-Statå…¬å¼URLç”Ÿæˆï¼‰
- `save_metadata_as_csv`ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®CSVä¿å­˜ï¼‰
- å…¨12ãƒ„ãƒ¼ãƒ«ã«æ•´ç†

### v2.2.0 (2026å¹´1æœˆ16æ—¥)

**Athenaãƒ„ãƒ¼ãƒ«ã®ä¿®æ­£**:
- Athenaãƒ¯ãƒ¼ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—å°Žå…¥ (`estat-mcp-workgroup`)
- å‡ºåŠ›å…ˆã‚’`s3://estat-data-lake/athena-results/`ã«çµ±ä¸€
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¿®æ­£**:
- `mcp_aws_wrapper.py`ã‚’å‰Šé™¤ï¼ˆä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ï¼‰
- æ­£ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ–‡æ›¸åŒ–

### v2.1.0 (2026å¹´1æœˆ15æ—¥)

**åˆç‰ˆãƒªãƒªãƒ¼ã‚¹**:
- MCP streamable-httpãƒ—ãƒ­ãƒˆã‚³ãƒ«å¯¾å¿œ
- AWS ECS Fargateãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
- å…¨11ãƒ„ãƒ¼ãƒ«å®Ÿè£…å®Œäº†

---

**ä½œæˆæ—¥**: 2026å¹´1æœˆ16æ—¥  
**æœ€çµ‚æ›´æ–°**: 2026å¹´1æœˆ16æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v2.3.0  
**ä½œæˆè€…**: Kiro AI Assistant
