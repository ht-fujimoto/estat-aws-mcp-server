# 要件定義書: estat-aws 全機能実装

## はじめに

estat-awsは現在、基本的な検索機能のみを提供していますが、estat-enhancedが持つ全10個のツール機能を実装することで、クラウド環境でもローカル版と同等の高度なデータ分析機能を提供します。

## 用語集

- **システム**: estat-aws MCPサーバー全体を指す
- **estat-aws**: AWS ECS Fargate上で動作するe-Stat MCPサーバー
- **estat-enhanced**: ローカル環境で動作する高機能版e-Stat MCPサーバー
- **MCPサーバー**: Model Context Protocolに準拠したサーバー
- **ECS_Fargate**: AWSのサーバーレスコンテナ実行環境
- **e-Stat_API**: 日本政府統計の総合窓口API
- **キーワードサジェスト**: 統計用語辞書を使用した検索キーワード最適化機能
- **S3**: Amazon Simple Storage Service（オブジェクトストレージ）
- **Parquet**: 列指向データフォーマット
- **Iceberg**: テーブルフォーマット仕様
- **Athena**: AWSのサーバーレスクエリサービス
- **データセット**: e-Stat APIから取得できる統計データの単位
- **チャンク取得**: 大規模データを分割して取得する方式

## 要件

### 要件1: キーワードサジェスト付き拡張検索

**ユーザーストーリー:** データアナリストとして、自動キーワードサジェスト機能を使ってe-Statデータを検索したい。そうすることで、最適な統計用語を使用して最も関連性の高いデータセットを見つけることができる。

#### 受入基準

1. WHEN ユーザーが自然言語クエリで検索する THEN システムはクエリを分析し、統計用語の代替案を提案する
2. WHEN キーワードサジェストが利用可能な場合 THEN システムは元の検索結果と提案されたキーワードマッピングの両方を返す
3. THE システムはキーワードサジェストに134用語の統計用語辞書を使用する
4. WHEN データセットをスコアリングする THEN システムは8要素の拡張スコアリングアルゴリズムを使用する
5. THE システムは関連性スコアでランク付けされた結果を返す

### 要件2: キーワードサジェストの適用

**ユーザーストーリー:** データアナリストとして、提案されたキーワードを適用して検索を改善したい。そうすることで、より正確な結果を得ることができる。

#### 受入基準

1. WHEN ユーザーがキーワードサジェストを承認する THEN システムは承認されたキーワードで新しい検索クエリを生成する
2. THE システムは承認されたキーワードを置き換えながら、元のクエリ構造を保持する
3. THE システムはユーザー確認のために変更されたクエリを返す

### 要件3: データセットの自動取得

**ユーザーストーリー:** データアナリストとして、完全なデータセットを自動的に取得したい。そうすることで、手動介入なしにデータを分析できる。

#### 受入基準

1. WHEN データセットIDが提供される THEN システムはe-Stat APIから完全なデータセットを取得する
2. WHEN データセットサイズが10万レコード未満の場合 THEN システムは単一リクエストで取得する
3. WHEN データセットサイズが10万レコードを超える THEN システムは自動的にチャンク取得を使用する
4. THE システムは取得したデータをオプションでS3に保存する
5. THE システムはコード値をオプションで日本語名に変換する

### 要件4: 大規模データセットの完全取得

**ユーザーストーリー:** データアナリストとして、大規模データセット（最大100万レコード）を取得したい。そうすることで、包括的な統計データを分析できる。

#### 受入基準

1. WHEN 大規模データセットが要求される THEN システムはチャンクで取得する
2. THE システムは最大1,000,000レコードのデータセットをサポートする
3. THE システムはチャンクサイズを設定可能にする（デフォルト: 100,000レコード）
4. THE システムはすべてのチャンクを単一のデータセットに結合する
5. THE システムは完全なデータセットをS3に保存する

### 要件5: フィルタリングされたデータセット取得

**ユーザーストーリー:** データアナリストとして、取得前にカテゴリでデータセットをフィルタリングしたい。そうすることで、データサイズを削減し、関連するサブセットに焦点を当てることができる。

#### 受入基準

1. WHEN フィルタ条件が提供される THEN システムはe-Stat APIリクエストにそれらを適用する
2. THE システムは地域、時間、その他の次元によるフィルタリングをサポートする
3. THE システムはAPIリクエストを行う前にフィルタ条件を検証する
4. THE システムはフィルタリングされたデータのサブセットのみを返す

### 要件6: Parquet変換

**ユーザーストーリー:** データエンジニアとして、JSONデータをParquet形式に変換したい。そうすることで、ストレージとクエリパフォーマンスを最適化できる。

#### 受入基準

1. WHEN JSONデータがS3に保存されている THEN システムはそれをParquet形式に変換する
2. THE システムは変換中にすべてのデータ型を保持する
3. THE システムはParquetファイルをS3に保存する
4. THE システムはParquetファイルのS3パスを返す

### 要件7: Icebergテーブルへのロード

**ユーザーストーリー:** データエンジニアとして、ParquetデータをIcebergテーブルにロードしたい。そうすることで、ACIDトランザクションとタイムトラベル機能を使用できる。

#### 受入基準

1. WHEN ParquetデータがS3で利用可能な場合 THEN システムはそれをIcebergテーブルにロードする
2. THE システムはテーブルが存在しない場合は作成する
3. THE システムは既存のテーブルにデータを追加する
4. THE システムはテーブル名とレコード数を返す

### 要件8: Athena分析

**ユーザーストーリー:** データアナリストとして、Athenaを使用して統計分析を実行したい。そうすることで、大規模データセットを効率的にクエリできる。

#### 受入基準

1. WHEN テーブル名が提供される THEN システムは基本的な統計クエリを実行する
2. THE システムは基本分析と高度分析の両方のタイプをサポートする
3. THE システムはオプションでカスタムSQLクエリを実行する
4. THE システムはクエリ結果をJSON形式で返す

### 要件9: CSVエクスポートとS3保存

**ユーザーストーリー:** データアナリストとして、データセットをCSVファイルとしてS3にエクスポートしたい。そうすることで、他のツールやユーザーとデータを共有できる。

#### 受入基準

1. WHEN データセットが取得される THEN システムはそれをCSV形式に変換する
2. THE システムはタイムスタンプ付きファイル名でCSVファイルをS3に保存する
3. THE システムはCSVファイルのS3パスを返す
4. THE システムは大規模データセットを効率的に処理する

### 要件10: S3からのCSVダウンロード

**ユーザーストーリー:** データアナリストとして、S3からローカルマシンにCSVファイルをダウンロードしたい。そうすることで、オフラインでデータを操作できる。

#### 受入基準

1. WHEN S3パスが提供される THEN システムはCSVファイルをダウンロードする
2. THE システムは指定されたローカルパスにファイルを保存する
3. THE システムはローカルファイルパスを返す
4. THE システムは大きなファイルを効率的に処理する

### 要件11: AWS統合

**ユーザーストーリー:** システム管理者として、すべてのAWSサービスが適切に統合されていることを望む。そうすることで、システムがクラウドで確実に動作できる。

#### 受入基準

1. THE システムは環境変数またはIAMロールからAWS認証情報を使用する
2. THE システムは適切な権限でS3バケットにアクセスする
3. THE システムはロギングにCloudWatchを使用する
4. THE システムはAWSサービスエラーを適切に処理する

### 要件12: エラーハンドリングと回復性

**ユーザーストーリー:** システム管理者として、堅牢なエラーハンドリングを望む。そうすることで、システムが障害から適切に回復できる。

#### 受入基準

1. WHEN e-Stat APIがエラーを返す THEN システムは説明的なエラーメッセージを返す
2. WHEN AWSサービスが利用できない THEN システムは指数バックオフで再試行する
3. WHEN データ変換が失敗する THEN システムはエラーをログに記録し、意味のあるメッセージを返す
4. THE システムはエラーメッセージで機密情報を公開しない

### 要件13: パフォーマンスとスケーラビリティ

**ユーザーストーリー:** システム管理者として、システムが同時リクエストを効率的に処理することを望む。そうすることで、複数のユーザーが同時に使用できる。

#### 受入基準

1. THE システムはブロッキングなしで複数の同時リクエストを処理する
2. THE システムはe-Stat APIリクエストにコネクションプーリングを使用する
3. THE システムは適切な場合、頻繁にアクセスされるデータをキャッシュする
4. THE システムはほとんどの操作を60秒以内に完了する

### 要件14: 後方互換性

**ユーザーストーリー:** 開発者として、新しい実装が既存のクライアントと後方互換性があることを望む。そうすることで、現在の統合が引き続き機能する。

#### 受入基準

1. THE システムは同じMCPプロトコルインターフェースを維持する
2. THE システムはすべての既存のツール名とパラメータをサポートする
3. THE システムはestat-enhancedと同じ形式でレスポンスを返す
4. WHEN 新機能が追加される THEN システムは既存の機能を壊さない
