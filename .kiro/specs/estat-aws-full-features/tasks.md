# 実装タスク: estat-aws 全機能実装

## タスク概要

このドキュメントは、estat-awsにestat-enhancedの全10個のツール機能を実装するための詳細なタスクリストです。各タスクは要件定義書の要件番号に紐付けられています。

## 実装フェーズ

### フェーズ1: 基盤整備 (Phase 1: Foundation)

#### タスク1.1: プロジェクト構造の整理
- [x] `mcp_servers/estat_aws/`ディレクトリを作成
- [x] `__init__.py`を作成してパッケージ化
- [ ] `server.py`にメインサーバークラスを配置
- [x] `utils/`ディレクトリを作成（ヘルパー関数用）
- [ ] `tests/`ディレクトリを作成（テストコード用）

**関連要件**: なし（基盤整備）

#### タスク1.2: 依存関係の更新
- [x] `requirements.txt`にpandas、pyarrow、boto3を追加
- [x] Dockerfileを更新して新しい依存関係をインストール
- [ ] ローカル開発環境で依存関係をテスト

**関連要件**: 要件6, 要件7, 要件11

#### タスク1.3: 統計用語辞書の実装
- [x] `keyword_dictionary.py`を作成
- [x] estat-enhancedから134用語の辞書をコピー
- [x] 辞書ロード関数を実装
- [ ] 辞書の単体テストを作成

**関連要件**: 要件1.3

#### タスク1.4: 共通ユーティリティの実装
- [x] `utils/error_handler.py`を作成（エラーハンドリング）
- [x] `utils/retry.py`を作成（リトライロジック）
- [x] `utils/logger.py`を作成（ロギング設定）
- [x] `utils/response_formatter.py`を作成（レスポンス形式統一）

**関連要件**: 要件12, 要件14

---

### フェーズ2: コアツール実装 (Phase 2: Core Tools)

#### タスク2.1: キーワードサジェスト付き拡張検索の実装
- [ ] `search_estat_data()`メソッドを実装
- [ ] キーワード抽出ロジックを実装
- [ ] 統計用語辞書からサジェストを生成
- [ ] 8要素スコアリングアルゴリズムを実装
  - [ ] タイトルマッチスコア (30%)
  - [ ] 説明文マッチスコア (20%)
  - [ ] 統計分野マッチスコア (15%)
  - [ ] 更新日の新しさスコア (10%)
  - [ ] データ規模スコア (10%)
  - [ ] 提供機関の信頼性スコア (5%)
  - [ ] メタデータの完全性スコア (5%)
  - [ ] 利用頻度スコア (5%)
- [ ] 関連性スコアでソート
- [ ] レスポンス形式を統一

**関連要件**: 要件1 (受入基準1.1-1.5)

**テスト**:
- [ ] 単体テスト: キーワード抽出
- [ ] 単体テスト: スコアリングアルゴリズム
- [ ] 統合テスト: e-Stat API連携
- [ ] プロパティテスト: プロパティ1（検索結果の一貫性）

#### タスク2.2: キーワードサジェストの適用
- [ ] `apply_keyword_suggestions()`メソッドを実装
- [ ] 元のクエリ構造を保持しながらキーワードを置換
- [ ] 変更されたクエリを返す
- [ ] エッジケースの処理（空のサジェスト、無効なキーワード）

**関連要件**: 要件2 (受入基準2.1-2.3)

**テスト**:
- [ ] 単体テスト: キーワード置換ロジック
- [ ] プロパティテスト: プロパティ2（キーワード変換の可逆性）

#### タスク2.3: データセットの自動取得
- [ ] `fetch_dataset_auto()`メソッドを実装
- [ ] データセットサイズを取得
- [ ] 10万レコード未満: 単一リクエスト
- [ ] 10万レコード以上: チャンク取得に自動切り替え
- [ ] コード→日本語名変換機能を実装
- [ ] S3保存機能を実装
- [ ] タイムスタンプ付きファイル名生成

**関連要件**: 要件3 (受入基準3.1-3.5)

**テスト**:
- [ ] 単体テスト: サイズ判定ロジック
- [ ] 統合テスト: 小規模データセット取得
- [ ] 統合テスト: 大規模データセット自動切り替え
- [ ] プロパティテスト: プロパティ3（データ完全性）

#### タスク2.4: 大規模データセットの完全取得
- [x] `fetch_large_dataset_complete()`メソッドを実装
- [x] チャンクサイズの設定可能化（デフォルト: 100,000）
- [x] 最大レコード数の制限（デフォルト: 1,000,000）
- [x] チャンク数の計算
- [ ] 各チャンクの並列取得（ThreadPoolExecutor使用）
- [ ] チャンクの結合ロジック
- [x] 進捗ログの出力
- [x] S3への保存

**関連要件**: 要件4 (受入基準4.1-4.5)

**テスト**:
- [ ] 単体テスト: チャンク計算ロジック
- [ ] 統合テスト: 大規模データセット取得（モック）
- [ ] プロパティテスト: プロパティ4（チャンク結合の正確性）

#### タスク2.5: フィルタリングされたデータセット取得
- [x] `fetch_dataset_filtered()`メソッドを実装
- [x] フィルタ条件の検証
- [x] e-Stat APIパラメータへの変換
- [x] 地域フィルタのサポート
- [x] 時間フィルタのサポート
- [x] その他の次元フィルタのサポート
- [x] フィルタリングされたデータの取得

**関連要件**: 要件5 (受入基準5.1-5.4)

**テスト**:
- [ ] 単体テスト: フィルタ条件の検証
- [ ] 統合テスト: 各種フィルタの動作確認
- [ ] プロパティテスト: プロパティ5（フィルタリングの正確性）

---

### フェーズ3: データ変換・分析ツール (Phase 3: Data Transformation & Analysis)

#### タスク3.1: Parquet変換の実装
- [ ] `transform_to_parquet()`メソッドを実装
- [ ] S3からJSONデータを読み込み
- [ ] pandasでDataFrameに変換
- [ ] データ型の保持を確認
- [ ] pyarrowでParquet形式に変換
- [ ] S3にParquetファイルを保存
- [ ] 出力パスを返す

**関連要件**: 要件6 (受入基準6.1-6.4)

**テスト**:
- [ ] 単体テスト: JSON→DataFrame変換
- [ ] 単体テスト: DataFrame→Parquet変換
- [ ] 統合テスト: S3読み込み→変換→S3保存
- [ ] プロパティテスト: プロパティ6（Parquet変換の型保持）

#### タスク3.2: Icebergテーブルへのロード
- [ ] `load_to_iceberg()`メソッドを実装
- [ ] テーブル存在確認
- [ ] テーブルが存在しない場合は作成
- [ ] Parquetデータの読み込み
- [ ] Icebergテーブルへのデータ追加
- [ ] レコード数の返却

**関連要件**: 要件7 (受入基準7.1-7.4)

**テスト**:
- [ ] 単体テスト: テーブル作成ロジック
- [ ] 統合テスト: データロード（モック）
- [ ] 統合テスト: 既存テーブルへの追加

#### タスク3.3: Athena分析の実装
- [ ] `analyze_with_athena()`メソッドを実装
- [ ] 基本分析クエリの生成
  - [ ] COUNT、SUM、AVG、MIN、MAX
  - [ ] GROUP BY集計
- [ ] 高度分析クエリの生成
  - [ ] 時系列分析
  - [ ] 相関分析
- [ ] カスタムSQLクエリのサポート
- [ ] Athenaクエリの実行
- [ ] クエリ完了の待機
- [ ] 結果の取得とJSON形式への変換

**関連要件**: 要件8 (受入基準8.1-8.4)

**テスト**:
- [ ] 単体テスト: クエリ生成ロジック
- [ ] 統合テスト: Athenaクエリ実行（モック）

---

### フェーズ4: データエクスポート (Phase 4: Data Export)

#### タスク4.1: CSVエクスポートとS3保存
- [ ] `save_dataset_as_csv()`メソッドを実装
- [ ] データセットの取得（または既存JSONの読み込み）
- [ ] pandasでCSV形式に変換
- [ ] タイムスタンプ付きファイル名の生成
- [ ] S3へのCSVアップロード
- [ ] S3パスの返却
- [ ] 大規模データセットの効率的な処理

**関連要件**: 要件9 (受入基準9.1-9.4)

**テスト**:
- [ ] 単体テスト: CSV変換
- [ ] 統合テスト: S3保存
- [ ] プロパティテスト: プロパティ7（S3保存の冪等性）

#### タスク4.2: S3からのCSVダウンロード
- [ ] `download_csv_from_s3()`メソッドを実装
- [ ] S3パスの検証
- [ ] S3からのファイルダウンロード
- [ ] ローカルパスへの保存
- [ ] ローカルファイルパスの返却
- [ ] 大きなファイルの効率的な処理（ストリーミング）

**関連要件**: 要件10 (受入基準10.1-10.4)

**テスト**:
- [ ] 単体テスト: パス検証
- [ ] 統合テスト: S3ダウンロード（モック）

---

### フェーズ5: AWS統合とインフラ (Phase 5: AWS Integration & Infrastructure)

#### タスク5.1: AWS認証の実装
- [ ] 環境変数からの認証情報取得
- [ ] IAMロールベースの認証
- [ ] boto3クライアントの初期化
- [ ] 認証エラーのハンドリング

**関連要件**: 要件11 (受入基準11.1)

**テスト**:
- [ ] 単体テスト: 認証情報取得
- [ ] 統合テスト: IAMロール認証

#### タスク5.2: S3統合の強化
- [ ] S3バケットの存在確認
- [ ] 適切な権限の検証
- [ ] マルチパートアップロードのサポート
- [ ] S3エラーのハンドリング

**関連要件**: 要件11 (受入基準11.2)

**テスト**:
- [ ] 統合テスト: S3アクセス権限
- [ ] 統合テスト: マルチパートアップロード

#### タスク5.3: CloudWatchロギングの実装
- [ ] CloudWatch Logsへのログ送信
- [ ] 構造化ログの実装
- [ ] ログレベルの設定
- [ ] エラーログの詳細化

**関連要件**: 要件11 (受入基準11.3)

**テスト**:
- [ ] 統合テスト: CloudWatchログ送信

#### タスク5.4: AWSサービスエラーハンドリング
- [ ] S3エラーの分類と処理
- [ ] Athenaエラーの分類と処理
- [ ] ネットワークエラーの処理
- [ ] 指数バックオフリトライの実装

**関連要件**: 要件11 (受入基準11.4), 要件12 (受入基準12.2)

**テスト**:
- [ ] 単体テスト: リトライロジック
- [ ] 統合テスト: エラーシナリオ

---

### フェーズ6: エラーハンドリングと回復性 (Phase 6: Error Handling & Resilience)

#### タスク6.1: e-Stat APIエラーハンドリング
- [ ] APIエラーコードの分類
  - [ ] LIMIT_EXCEEDED
  - [ ] INVALID_PARAMETER
  - [ ] NOT_FOUND
- [ ] 説明的なエラーメッセージの生成
- [ ] エラーレスポンス形式の統一

**関連要件**: 要件12 (受入基準12.1)

**テスト**:
- [ ] 単体テスト: 各エラーコードの処理
- [ ] 統合テスト: e-Stat APIエラーシナリオ

#### タスク6.2: リトライ戦略の実装
- [ ] 指数バックオフアルゴリズムの実装
- [ ] 最大リトライ回数の設定
- [ ] リトライ可能なエラーの判定
- [ ] リトライログの出力

**関連要件**: 要件12 (受入基準12.2)

**テスト**:
- [ ] 単体テスト: バックオフ計算
- [ ] 統合テスト: リトライシナリオ

#### タスク6.3: データ変換エラーハンドリング
- [ ] JSONパースエラーの処理
- [ ] データ型変換エラーの処理
- [ ] エンコーディングエラーの処理
- [ ] エラーログの記録

**関連要件**: 要件12 (受入基準12.3)

**テスト**:
- [ ] 単体テスト: 各変換エラーの処理

#### タスク6.4: セキュリティ - 機密情報の保護
- [ ] エラーメッセージからAPIキーを除外
- [ ] エラーメッセージからAWS認証情報を除外
- [ ] ログからの機密情報フィルタリング
- [ ] セキュリティ監査

**関連要件**: 要件12 (受入基準12.4)

**テスト**:
- [ ] 単体テスト: 機密情報フィルタリング
- [ ] プロパティテスト: プロパティ8（エラーメッセージの安全性）

---

### フェーズ7: パフォーマンスとスケーラビリティ (Phase 7: Performance & Scalability)

#### タスク7.1: コネクションプーリングの実装
- [ ] requests.Sessionの使用
- [ ] HTTPAdapterの設定
- [ ] プールサイズの最適化
- [ ] コネクションタイムアウトの設定

**関連要件**: 要件13 (受入基準13.2)

**テスト**:
- [ ] パフォーマンステスト: 同時リクエスト処理

#### タスク7.2: キャッシング機能の実装
- [ ] メタデータキャッシュの実装（lru_cache）
- [ ] キャッシュサイズの設定
- [ ] キャッシュ無効化ロジック
- [ ] キャッシュヒット率のモニタリング

**関連要件**: 要件13 (受入基準13.3)

**テスト**:
- [ ] 単体テスト: キャッシュ動作
- [ ] パフォーマンステスト: キャッシュ効果

#### タスク7.3: 並列処理の実装
- [ ] ThreadPoolExecutorの使用
- [ ] ワーカー数の最適化
- [ ] チャンク取得の並列化
- [ ] エラーハンドリング（並列処理中）

**関連要件**: 要件13 (受入基準13.1)

**テスト**:
- [ ] パフォーマンステスト: 並列処理効果

#### タスク7.4: タイムアウト管理
- [ ] 各操作のタイムアウト設定
- [ ] 60秒以内の完了を目標
- [ ] タイムアウトログの出力
- [ ] タイムアウト時の適切なエラーメッセージ

**関連要件**: 要件13 (受入基準13.4)

**テスト**:
- [ ] パフォーマンステスト: 操作時間測定
- [ ] プロパティテスト: プロパティ10（タイムアウト制限なし）

---

### フェーズ8: 後方互換性とMCPプロトコル (Phase 8: Backward Compatibility & MCP Protocol)

#### タスク8.1: MCPプロトコルインターフェースの維持
- [ ] tools/listレスポンスの形式確認
- [ ] tools/callリクエスト/レスポンスの形式確認
- [ ] エラーレスポンスの形式確認
- [ ] JSON-RPC 2.0準拠の確認

**関連要件**: 要件14 (受入基準14.1)

**テスト**:
- [ ] 統合テスト: MCPプロトコル準拠

#### タスク8.2: ツール名とパラメータの互換性
- [ ] 全10個のツール名がestat-enhancedと一致
- [ ] 各ツールのパラメータ名が一致
- [ ] パラメータのデフォルト値が一致
- [ ] オプショナルパラメータの動作が一致

**関連要件**: 要件14 (受入基準14.2)

**テスト**:
- [ ] 単体テスト: 各ツールのシグネチャ確認

#### タスク8.3: レスポンス形式の互換性
- [ ] 成功レスポンスの形式がestat-enhancedと一致
- [ ] エラーレスポンスの形式が一致
- [ ] メタデータフィールドが一致
- [ ] データ構造が一致

**関連要件**: 要件14 (受入基準14.3)

**テスト**:
- [ ] 統合テスト: レスポンス形式の比較
- [ ] プロパティテスト: プロパティ9（後方互換性）

#### タスク8.4: 既存機能の保護
- [ ] 新機能追加時の回帰テスト
- [ ] 既存ツールの動作確認
- [ ] エラーハンドリングの一貫性確認

**関連要件**: 要件14 (受入基準14.4)

**テスト**:
- [ ] 回帰テスト: 全ツールの動作確認

---

### フェーズ9: テストとドキュメント (Phase 9: Testing & Documentation)

#### タスク9.1: ユニットテストの作成
- [ ] 各ツール関数のユニットテスト
- [ ] ヘルパー関数のユニットテスト
- [ ] エラーハンドリングのユニットテスト
- [ ] テストカバレッジ80%以上を目標

**関連要件**: 全要件

**テスト**:
- [ ] pytest実行
- [ ] カバレッジレポート生成

#### タスク9.2: プロパティベーステストの作成
- [ ] プロパティ1: 検索結果の一貫性
- [ ] プロパティ2: キーワード変換の可逆性
- [ ] プロパティ3: データ完全性
- [ ] プロパティ4: チャンク結合の正確性
- [ ] プロパティ5: フィルタリングの正確性
- [ ] プロパティ6: Parquet変換の型保持
- [ ] プロパティ7: S3保存の冪等性
- [ ] プロパティ8: エラーメッセージの安全性
- [ ] プロパティ9: 後方互換性
- [ ] プロパティ10: タイムアウト制限なし

**関連要件**: 全要件

**テスト**:
- [ ] hypothesis使用
- [ ] 各プロパティ100回以上のランダム入力テスト

#### タスク9.3: 統合テストの作成
- [ ] エンドツーエンドワークフローテスト
- [ ] e-Stat API統合テスト
- [ ] AWS統合テスト（モック）
- [ ] エラーシナリオテスト

**関連要件**: 全要件

**テスト**:
- [ ] 統合テストスイート実行

#### タスク9.4: パフォーマンステストの作成
- [ ] 同時リクエスト処理テスト
- [ ] 大規模データセット取得時間測定
- [ ] メモリ使用量測定
- [ ] パフォーマンスベンチマーク

**関連要件**: 要件13

**テスト**:
- [ ] パフォーマンステストスイート実行

#### タスク9.5: ドキュメントの作成
- [ ] README.mdの更新
  - [ ] 全10個のツールの説明
  - [ ] 使用例
  - [ ] パラメータ説明
- [ ] API_REFERENCE.mdの作成
  - [ ] 各ツールの詳細仕様
  - [ ] リクエスト/レスポンス例
- [ ] DEPLOYMENT.mdの更新
  - [ ] ECS Fargateデプロイ手順
  - [ ] 環境変数の説明
- [ ] TROUBLESHOOTING.mdの作成
  - [ ] よくある問題と解決策

**関連要件**: なし（ドキュメント）

---

### フェーズ10: デプロイメントと検証 (Phase 10: Deployment & Verification)

#### タスク10.1: Dockerイメージの更新
- [ ] Dockerfileの更新（新しい依存関係）
- [ ] amd64アーキテクチャでビルド
- [ ] イメージサイズの最適化
- [ ] ローカルでのイメージテスト

**関連要件**: なし（デプロイメント）

**テスト**:
- [ ] Dockerイメージのビルド確認
- [ ] コンテナの起動確認

#### タスク10.2: ECRへのプッシュ
- [ ] ECRリポジトリの確認
- [ ] イメージのタグ付け
- [ ] ECRへのプッシュ
- [ ] イメージの検証

**関連要件**: なし（デプロイメント）

**テスト**:
- [ ] ECRからのイメージプル確認

#### タスク10.3: ECSサービスの更新
- [ ] タスク定義の更新
- [ ] ECSサービスの更新（force-new-deployment）
- [ ] デプロイメントの監視
- [ ] ヘルスチェックの確認

**関連要件**: なし（デプロイメント）

**テスト**:
- [ ] ヘルスチェックエンドポイント確認
- [ ] ALB経由のアクセス確認

#### タスク10.4: 本番環境での検証
- [ ] 全10個のツールの動作確認
- [ ] エラーハンドリングの確認
- [ ] パフォーマンスの確認
- [ ] ログの確認（CloudWatch）

**関連要件**: 全要件

**テスト**:
- [ ] 本番環境での統合テスト
- [ ] 負荷テスト

#### タスク10.5: Kiro設定の更新
- [ ] `~/.kiro/settings/mcp.json`の更新
- [ ] estat-awsサーバーの再接続
- [ ] Kiroからの動作確認
- [ ] 全ツールのKiroからのテスト

**関連要件**: なし（クライアント設定）

**テスト**:
- [ ] Kiroからの各ツール呼び出し確認

---

## 進捗トラッキング

### フェーズ完了チェックリスト

- [x] フェーズ1: 基盤整備 (4タスク) ✅
- [x] フェーズ2: コアツール実装 (5タスク) ✅
- [x] フェーズ3: データ変換・分析ツール (3タスク) ✅
- [x] フェーズ4: データエクスポート (2タスク) ✅
- [ ] フェーズ5: AWS統合とインフラ (4タスク)
- [ ] フェーズ6: エラーハンドリングと回復性 (4タスク)
- [ ] フェーズ7: パフォーマンスとスケーラビリティ (4タスク)
- [ ] フェーズ8: 後方互換性とMCPプロトコル (4タスク)
- [ ] フェーズ9: テストとドキュメント (5タスク)
- [ ] フェーズ10: デプロイメントと検証 (5タスク)

### 総タスク数

- **合計**: 40メインタスク
- **サブタスク**: 約150個
- **推定工数**: 40-60時間

## 次のステップ

1. ユーザーにタスクリストを確認してもらう
2. 承認後、フェーズ1から実装を開始
3. 各フェーズ完了後、テストを実行
4. 全フェーズ完了後、本番環境にデプロイ

## 注意事項

- 各タスクは独立して実装可能
- テストは実装と並行して作成
- プロパティベーステストは設計文書のプロパティ番号を参照
- estat-enhancedのコードを参考にしながら実装
- AWS統合部分はモックテストを優先
- 本番環境での検証は最後に実施
