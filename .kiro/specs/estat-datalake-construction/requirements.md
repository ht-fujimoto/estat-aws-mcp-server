# 要件定義書

## はじめに

本書は、E-stat APIから取得可能な全データを取り込み、AWS S3上にApache Iceberg形式で格納する包括的なデータレイクを構築するための要件を定義します。このシステムは、AIエージェントが統計データを検索・取得して分析を行うことを可能にし、既存のE-stat AWS統合機能を基盤として構築されます。

## 用語集

- **データレイク**: S3上にIceberg形式で構造化された統計データを格納する一元化されたリポジトリ
- **E-stat_API**: 日本政府の統計データへのアクセスを提供する公式統計API
- **Icebergテーブル**: ACIDトランザクションとスキーマ進化を提供するApache Icebergテーブル形式
- **データセット**: E-statから取得される関連メタデータを含む完全な統計表
- **メタデータ**: カテゴリ、次元、構造を含むデータセットの記述情報
- **取り込みパイプライン**: E-stat APIからデータを取得しIcebergテーブルにロードする自動化プロセス
- **カタログ**: データレイク内の全Icebergテーブルとそのスキーマのレジストリ
- **パーティション**: クエリ最適化のためのIcebergテーブル内のデータの論理的分割
- **スキーマ進化**: 既存データを書き換えることなくテーブル構造を変更する機能

## 要件

### 要件1: データレイク基盤

**ユーザーストーリー:** データエンジニアとして、統計データをスケーラブルでクエリ可能な形式で保存できるよう、AWS S3上にIcebergベースのデータレイク基盤を構築したい。

#### 受入基準

1. データレイクは、整理されたプレフィックス構造を持つ指定されたS3バケットに全てのIcebergテーブルを格納しなければならない
2. カタログは、AWS Glue Data Catalogを使用して全てのIcebergテーブルのメタデータを維持しなければならない
3. 新しいテーブルが作成されたとき、データレイクは完全なスキーマ情報と共にカタログに登録しなければならない
4. データレイクは、Icebergテーブルへの全ての書き込み操作に対してACIDトランザクションをサポートしなければならない
5. データレイクは、データセットの特性（時間ベース、カテゴリベース）に基づいたパーティション戦略を実装しなければならない

### 要件2: E-statデータの選択と管理

**ユーザーストーリー:** システム管理者として、データレイク構築の実現可能性を検証できるよう、まず一部のE-statデータセットを選択して取り込みたい。

#### 受入基準

1. システムは、取り込み対象とするデータセットを手動で指定できる設定機能を提供しなければならない
2. データセットを選択する際、システムはデータセットID、タイトル、サイズ、更新頻度を表示しなければならない
3. システムは、選択されたデータセットのリストと取り込みステータスを維持しなければならない
4. システムは、選択されたデータセットのメタデータを取得して保存しなければならない
5. 将来的な拡張のため、システムは追加のデータセットを段階的に追加できる設計でなければならない

### 要件3: 選択的なデータ取り込み

**ユーザーストーリー:** データエンジニアとして、システムリソースを効率的に使用しながらデータレイクの実現可能性を検証できるよう、選択したE-statデータセットを取り込みたい。

#### 受入基準

1. 取り込みパイプラインは、設定ファイルまたはパラメータで指定されたデータセットのみを処理しなければならない
2. データセットを取り込む際、システムは全ての履歴レコードを含む完全なデータを取得しなければならない
3. 取り込みパイプラインは、チャンク取得を使用して大規模データセット（10万レコード以上）を処理しなければならない
4. データセットの取り込みが失敗したとき、システムはエラーをログに記録し、詳細な診断情報を提供しなければならない
5. システムは、取り込み進捗を追跡し、中断後に最後の成功したチェックポイントから再開しなければならない

### 要件4: データ変換とスキーママッピング

**ユーザーストーリー:** データエンジニアとして、効率的な分析クエリのためにデータが構造化されるよう、E-statデータを最適化されたIcebergスキーマに変換したい。

#### 受入基準

1. E-statデータを受信したとき、システムはJSONレスポンスを解析し、次元と共に統計値を抽出しなければならない
2. システムは、E-statカテゴリコードを日本語の人間が読める列名に変換しなければならない
3. システムは、各列に対して適切なデータ型（数値、文字列、日付）を推論しなければならない
4. システムは、次元とメジャーを分離した正規化されたスキーマを作成しなければならない
5. 複数のデータセットが共通の次元を共有する場合、システムは一貫した命名規則を使用しなければならない

### 要件5: Icebergテーブルの作成と管理

**ユーザーストーリー:** データエンジニアとして、データがクエリ可能な形式で保存されるよう、各E-statデータセットに対してIcebergテーブルを作成・管理したい。

#### 受入基準

1. システムは、適切なスキーマを持つE-statデータセットごとに1つのIcebergテーブルを作成しなければならない
2. テーブルを作成する際、システムはデータ特性に基づいたパーティション仕様を定義しなければならない
3. システムは、最適なクエリパフォーマンスのためのテーブルプロパティ（ソート、バケッティング）を設定しなければならない
4. システムは、E-statデータセットが新しい列で更新された際のスキーマ進化をサポートしなければならない
5. データを書き込む際、システムはストレージ効率のためにParquetファイル形式を使用しなければならない

### 要件6: データ品質と検証

**ユーザーストーリー:** データアナリストとして、分析のためにデータを信頼できるよう、取り込まれたデータが検証され品質チェックされることを望む。

#### 受入基準

1. システムは、E-statメタデータから要求される全ての列が取り込まれたデータに存在することを検証しなければならない
2. データを取り込む際、システムは主要な次元のnull値をチェックし、警告をログに記録しなければならない
3. システムは、メタデータに基づいて数値が期待される範囲内にあることを検証しなければならない
4. システムは、次元の組み合わせに基づいて重複レコードを検出・処理しなければならない
5. 検証が失敗したとき、システムは問題のあるレコードを隔離し、有効なデータの処理を継続しなければならない

### 要件7: メタデータ管理

**ユーザーストーリー:** データアナリストとして、データセットのコンテキストと構造を理解できるよう、データと共に包括的なメタデータが保存されることを望む。

#### 受入基準

1. システムは、E-statメタデータ（カテゴリ、次元、単位）をIcebergテーブルプロパティとして保存しなければならない
2. テーブルを作成する際、システムはデータセットの説明、ソースURL、更新タイムスタンプを含めなければならない
3. システムは、E-statデータセットIDとIcebergテーブル名をリンクする別個のメタデータテーブルを維持しなければならない
4. システムは、人間が読める名前と共に元のE-statカテゴリコードを保持しなければならない
5. システムは、取り込みタイムスタンプとソースAPIバージョンを追跡するデータリネージ情報を保存しなければならない

### 要件8: Athenaによるクエリインターフェース

**ユーザーストーリー:** データアナリストとして、統計データに対してSQLベースの分析を実行できるよう、AWS Athenaを使用してIcebergテーブルをクエリしたい。

#### 受入基準

1. データレイクは、標準SQL構文を使用してAWS Athenaを通じてクエリ可能でなければならない
2. クエリ実行時、システムはクエリ最適化とパーティションプルーニングのためにIcebergのメタデータを活用しなければならない
3. システムは、データの履歴バージョンにアクセスするためのタイムトラベルクエリをサポートしなければならない
4. システムは、データセット間の分析のために複数のIcebergテーブル間の結合を可能にしなければならない
5. クエリを実行する際、システムは許容可能なパフォーマンス閾値内で結果を返さなければならない

### 要件9: 増分更新とリフレッシュ

**ユーザーストーリー:** システム管理者として、データレイクを最新の状態に保つため、E-statで更新されたデータセットをリフレッシュしたい。

#### 受入基準

1. システムは、最後の取り込み以降にE-statで更新されたデータセットを識別しなければならない
2. データセットが更新されたとき、システムは新規または変更されたレコードのみを取得しなければならない
3. システムは、ダウンタイムなしでアトミックな更新を実行するためにIcebergのACID機能を使用しなければならない
4. システムは、タイムトラベルクエリのためにデータの履歴スナップショットを維持しなければならない
5. 更新が失敗したとき、システムは以前の一貫した状態にロールバックしなければならない

### 要件10: モニタリングと可観測性

**ユーザーストーリー:** システム管理者として、信頼性の高い運用を確保できるよう、データレイクの操作と健全性を監視したい。

#### 受入基準

1. システムは、タイムスタンプ、データセットID、レコード数と共に全ての取り込み操作をログに記録しなければならない
2. エラーが発生したとき、システムは詳細なエラーメッセージとスタックトレースをキャプチャしなければならない
3. システムは、取り込みスループット、ストレージ使用量、クエリパフォーマンスを含むメトリクスを追跡しなければならない
4. システムは、取り込み進捗とデータレイク統計を示すダッシュボードを提供しなければならない
5. 重大なエラーが発生したとき、システムは管理者に通知を送信しなければならない

### 要件11: コスト最適化

**ユーザーストーリー:** システム管理者として、データレイクを経済的に持続可能にするため、ストレージとコンピュートコストを最適化したい。

#### 受入基準

1. システムは、古いIcebergスナップショットをより安価なストレージ階層に移行するためにS3ライフサイクルポリシーを使用しなければならない
2. データを書き込む際、システムは効率的なコーデック（Snappy、ZSTD）を使用してファイルを圧縮しなければならない
3. システムは、メタデータオーバーヘッドを削減するために小さなファイルをより大きなファイルに圧縮しなければならない
4. システムは、クエリ中にスキャンされるデータを最小化するためにデータをパーティション化しなければならない
5. システムは、ストレージコストを削減するために保持期間を超えた古いスナップショットを期限切れにしなければならない

