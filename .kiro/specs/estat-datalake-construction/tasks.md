# 実装計画: E-stat Icebergデータレイク構築

## 概要

E-stat APIから取得したデータをApache Iceberg形式でAWS S3に格納するデータレイクを段階的に構築します。既存のE-stat AWS MCPサーバーの機能を活用し、Pythonで実装します。

## タスク

- [x] 1. データセット選択マネージャーの実装
  - [x] 1.1 設定ファイル管理機能の実装
    - YAMLファイルの読み書き機能
    - データセット情報の構造化
    - _要件: 2.1, 2.3_
  
  - [ ]* 1.2 設定のラウンドトリッププロパティテストを作成
    - **プロパティ5: 設定のラウンドトリップ**
    - **検証: 要件 2.1**
  
  - [x] 1.3 データセット追加・削除機能の実装
    - add_dataset()メソッド
    - remove_dataset()メソッド
    - _要件: 2.1_
  
  - [x] 1.4 優先度管理機能の実装
    - 優先度に基づくソート
    - get_next_dataset()メソッド
    - _要件: 2.3_
  
  - [x] 1.5 ステータス管理機能の実装
    - update_status()メソッド
    - ステータス履歴の記録
    - _要件: 2.3_
  
  - [ ]* 1.6 ステータス管理のプロパティテストを作成
    - **プロパティ6: ステータス管理の一貫性**
    - **検証: 要件 2.3**

- [x] 2. メタデータ管理システムの実装
  - [x] 2.1 dataset_inventory Icebergテーブルの作成
    - テーブルスキーマ定義
    - Athenaでのテーブル作成
    - _要件: 7.3_
  
  - [x] 2.2 MetadataManagerクラスの実装
    - register_dataset()メソッド
    - update_status()メソッド
    - get_dataset_info()メソッド
    - _要件: 7.3, 7.5_
  
  - [ ]* 2.3 データセットIDとテーブル名のマッピングプロパティテストを作成
    - **プロパティ21: データセットIDとテーブル名のマッピング**
    - **検証: 要件 7.3**
  
  - [x] 2.4 メタデータ取得と保存機能の実装
    - E-stat APIからのメタデータ取得
    - S3への保存
    - _要件: 2.4_
  
  - [ ]* 2.5 メタデータのラウンドトリッププロパティテストを作成
    - **プロパティ7: メタデータのラウンドトリップ**
    - **検証: 要件 2.4**

- [x] 3. チェックポイント - 基盤構築の確認
  - 全てのテストが通ることを確認
  - ユーザーに質問があれば確認

- [x] 4. スキーママッピングエンジンの実装
  - [x] 4.1 ドメイン別スキーマ定義の作成
    - DOMAIN_SCHEMAS辞書の定義
    - population, economy, genericスキーマ
    - _要件: 4.4, 5.1_
  
  - [x] 4.2 SchemaMapperクラスの実装
    - infer_domain()メソッド
    - get_schema()メソッド
    - map_estat_to_iceberg()メソッド
    - _要件: 4.1, 4.2, 4.3, 4.4_
  
  - [ ]* 4.3 JSON解析の正確性プロパティテストを作成
    - **プロパティ10: JSON解析の正確性**
    - **検証: 要件 4.1**
  
  - [ ]* 4.4 カテゴリコード変換プロパティテストを作成
    - **プロパティ11: カテゴリコード変換**
    - **検証: 要件 4.2**
  
  - [ ]* 4.5 データ型推論の正確性プロパティテストを作成
    - **プロパティ12: データ型推論の正確性**
    - **検証: 要件 4.3**
  
  - [ ]* 4.6 スキーマ正規化プロパティテストを作成
    - **プロパティ13: スキーマ正規化**
    - **検証: 要件 4.4**
  
  - [ ]* 4.7 命名規則の一貫性プロパティテストを作成
    - **プロパティ14: 命名規則の一貫性**
    - **検証: 要件 4.5**

- [x] 5. データ取り込みオーケストレーターの実装
  - [x] 5.1 DataIngestionOrchestratorクラスの基本実装
    - MCPクライアントの統合
    - 基本的なエラーハンドリング
    - _要件: 3.1, 3.2_
  
  - [x] 5.2 単一データセット取り込み機能の実装
    - ingest_dataset()メソッド
    - fetch_dataset_auto → transform_to_parquet → load_to_iceberg
    - _要件: 3.2, 4.1, 5.1_
  
  - [ ]* 5.3 データ完全性プロパティテストを作成
    - **プロパティ9: データ完全性**
    - **検証: 要件 3.2**
  
  - [x] 5.4 バッチ取り込み機能の実装
    - ingest_batch()メソッド
    - 優先度に基づく処理
    - _要件: 3.1_
  
  - [ ]* 5.5 データセットフィルタリングプロパティテストを作成
    - **プロパティ8: データセットフィルタリング**
    - **検証: 要件 3.1**
  
  - [x] 5.6 大規模データセット対応の実装
    - fetch_complete_dataset()関数
    - フィルタによる分割取得
    - _要件: 3.3_
  
  - [x] 5.7 大規模データセット取得の単体テストを作成
    - 10万件以上のデータセットでチャンク取得を確認
    - _要件: 3.3_
  
  - [x] 5.8 並列取得機能の実装
    - fetch_complete_dataset_parallel()関数
    - asyncio.gatherによる並列実行
    - _要件: 3.3_

- [x] 6. チェックポイント - データ取り込みの確認
  - 全てのテストが通ることを確認
  - ユーザーに質問があれば確認

- [x] 7. Icebergテーブル管理の実装
  - [x] 7.1 テーブル作成ロジックの実装
    - create_iceberg_table()関数
    - ドメイン別のスキーマ適用
    - _要件: 5.1, 5.2_
  
  - [ ]* 7.2 テーブル作成とスキーマ設定プロパティテストを作成
    - **プロパティ15: テーブル作成とスキーマ設定**
    - **検証: 要件 5.1, 5.2**
  
  - [x] 7.3 パーティション戦略の実装
    - ドメイン別のパーティションキー設定
    - パーティション仕様の定義
    - _要件: 1.5, 5.2_
  
  - [ ]* 7.4 パーティション戦略の適用プロパティテストを作成
    - **プロパティ4: パーティション戦略の適用**
    - **検証: 要件 1.5, 11.4**
  
  - [x] 7.5 テーブルプロパティの設定
    - table_type='ICEBERG'
    - format='parquet'
    - メタデータの保存
    - _要件: 5.3, 7.1, 7.2_
  
  - [ ]* 7.6 テーブルプロパティの設定プロパティテストを作成
    - **プロパティ16: テーブルプロパティの設定**
    - **検証: 要件 5.3**
  
  - [ ]* 7.7 テーブルメタデータの保存プロパティテストを作成
    - **プロパティ20: テーブルメタデータの保存**
    - **検証: 要件 7.1, 7.2**
  
  - [x] 7.8 S3バケット構造の検証
    - iceberg-tables/{domain}/{table_name}/構造
    - _要件: 1.1_
  
  - [ ]* 7.9 S3バケット構造の一貫性プロパティテストを作成
    - **プロパティ1: S3バケット構造の一貫性**
    - **検証: 要件 1.1**
  
  - [x] 7.10 Glue Catalog統合の実装
    - テーブル登録の確認
    - _要件: 1.2_
  
  - [ ]* 7.11 Glue Catalogへの登録プロパティテストを作成
    - **プロパティ2: Glue Catalogへの登録**
    - **検証: 要件 1.2**
  
  - [ ]* 7.12 スキーマのラウンドトリッププロパティテストを作成
    - **プロパティ3: スキーマのラウンドトリップ**
    - **検証: 要件 1.3**
  
  - [x] 7.13 スキーマ進化の単体テストを作成
    - 既存テーブルへの列追加
    - データ投入の確認
    - _要件: 5.4_
  
  - [ ]* 7.14 Parquetファイル形式プロパティテストを作成
    - **プロパティ17: Parquetファイル形式**
    - **検証: 要件 5.5**

- [x] 8. データ品質検証の実装
  - [x] 8.1 必須列の存在検証機能の実装
    - validate_required_columns()関数
    - メタデータとの照合
    - _要件: 6.1_
  
  - [ ]* 8.2 必須列の存在検証プロパティテストを作成
    - **プロパティ18: 必須列の存在検証**
    - **検証: 要件 6.1**
  
  - [x] 8.3 null値チェック機能の実装
    - check_null_values()関数
    - 警告ログの記録
    - _要件: 6.2_
  
  - [x] 8.4 null値の警告ログ単体テストを作成
    - null値を含むデータでログ記録を確認
    - _要件: 6.2_
  
  - [x] 8.5 数値範囲検証機能の実装
    - validate_value_ranges()関数
    - メタデータに基づく範囲チェック
    - _要件: 6.3_
  
  - [x] 8.6 範囲外の値の検証単体テストを作成
    - 範囲外の値で検証エラーを確認
    - _要件: 6.3_
  
  - [x] 8.7 重複レコード検出機能の実装
    - detect_duplicates()関数
    - 次元の組み合わせによる検出
    - _要件: 6.4_
  
  - [ ]* 8.8 重複レコードの検出プロパティテストを作成
    - **プロパティ19: 重複レコードの検出**
    - **検証: 要件 6.4**
  
  - [x] 8.9 不正レコードの隔離機能の実装
    - quarantine_invalid_records()関数
    - 有効なレコードの処理継続
    - _要件: 6.5_
  
  - [x] 8.10 不正レコードの隔離単体テストを作成
    - 不正レコードを含むデータで隔離を確認
    - _要件: 6.5_
  
  - [ ]* 8.11 カテゴリコードの保持プロパティテストを作成
    - **プロパティ22: カテゴリコードの保持**
    - **検証: 要件 7.4**

- [x] 9. チェックポイント - データ品質の確認
  - 全てのテストが通ることを確認
  - ユーザーに質問があれば確認

- [ ] 10. エラーハンドリングの実装
  - [ ] 10.1 ErrorHandlerクラスの実装
    - handle_ingestion_error()メソッド
    - エラー分類ロジック
    - _要件: 3.4_
  
  - [ ] 10.2 エラー発生時のログ記録単体テストを作成
    - 意図的にエラーを発生させてログ確認
    - _要件: 3.4_
  
  - [ ] 10.3 リトライロジックの実装
    - _is_retryable()メソッド
    - _get_retry_delay()メソッド
    - 指数バックオフ
    - _要件: 3.4_
  
  - [ ] 10.4 エラー時の詳細ログ単体テストを作成
    - スタックトレースの記録確認
    - _要件: 10.2_

- [ ] 11. ログ記録とメトリクス収集の実装
  - [ ] 11.1 取り込み操作のログ記録機能の実装
    - タイムスタンプ、データセットID、レコード数の記録
    - _要件: 10.1_
  
  - [ ]* 11.2 取り込み操作のログ記録プロパティテストを作成
    - **プロパティ26: 取り込み操作のログ記録**
    - **検証: 要件 10.1**
  
  - [ ] 11.3 メトリクス収集機能の実装
    - 取り込みスループット
    - ストレージ使用量
    - _要件: 10.3_
  
  - [ ]* 11.4 メトリクスの追跡プロパティテストを作成
    - **プロパティ27: メトリクスの追跡**
    - **検証: 要件 10.3**
  
  - [ ]* 11.5 データリネージ情報の保存プロパティテストを作成
    - **プロパティ23: データリネージ情報の保存**
    - **検証: 要件 7.5**
  
  - [ ] 11.6 通知機能の実装
    - 重大なエラー時の通知
    - _要件: 10.5_
  
  - [ ] 11.7 通知送信の単体テストを作成
    - 重大なエラーで通知送信を確認
    - _要件: 10.5_

- [ ] 12. 増分更新機能の実装
  - [ ] 12.1 更新データセット識別機能の実装
    - identify_updated_datasets()関数
    - 更新日時の比較
    - _要件: 9.1_
  
  - [ ]* 12.2 更新データセットの識別プロパティテストを作成
    - **プロパティ24: 更新データセットの識別**
    - **検証: 要件 9.1**
  
  - [ ] 12.3 差分取得機能の実装
    - fetch_incremental_data()関数
    - 新規・変更レコードのみ取得
    - _要件: 9.2_
  
  - [ ]* 12.4 差分取得プロパティテストを作成
    - **プロパティ25: 差分取得**
    - **検証: 要件 9.2**
  
  - [ ] 12.5 タイムトラベルクエリの単体テストを作成
    - 過去のスナップショットへのアクセス確認
    - _要件: 8.3_
  
  - [ ] 12.6 スナップショット管理の単体テストを作成
    - 更新後の履歴スナップショット確認
    - _要件: 9.4_

- [ ] 13. コスト最適化機能の実装
  - [ ] 13.1 ファイル圧縮設定の実装
    - Snappy/ZSTDコーデックの設定
    - _要件: 11.2_
  
  - [ ]* 13.2 ファイル圧縮プロパティテストを作成
    - **プロパティ28: ファイル圧縮**
    - **検証: 要件 11.2**
  
  - [ ] 13.3 S3ライフサイクルポリシーの設定
    - 古いスナップショットの移行
    - _要件: 11.1_
  
  - [ ] 13.4 S3ライフサイクルポリシーの単体テストを作成
    - ポリシー設定の確認
    - _要件: 11.1_
  
  - [ ] 13.5 ファイル圧縮機能の実装
    - compact_small_files()関数
    - 小さなファイルの統合
    - _要件: 11.3_
  
  - [ ] 13.6 ファイル圧縮の単体テストを作成
    - 小さなファイルの統合確認
    - _要件: 11.3_
  
  - [ ] 13.7 スナップショット期限切れ機能の実装
    - expire_old_snapshots()関数
    - 保持期間の設定
    - _要件: 11.5_
  
  - [ ] 13.8 スナップショット期限切れの単体テストを作成
    - 古いスナップショットの削除確認
    - _要件: 11.5_

- [ ] 14. Athenaクエリインターフェースの実装
  - [ ] 14.1 基本的なSQLクエリ実行の単体テストを作成
    - SELECT文の実行確認
    - _要件: 8.1_
  
  - [ ] 14.2 テーブル間JOINの単体テストを作成
    - 複数テーブルの結合確認
    - _要件: 8.4_

- [ ] 15. 統合とワイヤリング
  - [ ] 15.1 全コンポーネントの統合
    - DatasetSelectionManager
    - DataIngestionOrchestrator
    - SchemaMapper
    - MetadataManager
    - ErrorHandler
    - _要件: 全体_
  
  - [ ] 15.2 初期化スクリプトの作成
    - initialize_datalake.py
    - AWSリソースのプロビジョニング
    - _要件: 1.1, 1.2_
  
  - [ ] 15.3 バッチ取り込みスクリプトの作成
    - ingest_batch.py
    - コマンドラインインターフェース
    - _要件: 3.1_
  
  - [ ] 15.4 増分更新スクリプトの作成
    - ingest_updated_datasets.py
    - スケジュール実行対応
    - _要件: 9.1, 9.2_
  
  - [ ] 15.5 運用スクリプトの作成
    - check_new_datasets.py
    - validate_data_quality.py
    - generate_metrics_report.py
    - _要件: 10.1, 10.3_

- [ ] 16. 最終チェックポイント - 全体の確認
  - 全てのテストが通ることを確認
  - ユーザーに質問があれば確認

## 注記

- `*`マークのタスクはオプション（プロパティベーステスト）で、コア機能の実装を優先する場合はスキップ可能
- 各タスクは前のタスクに依存しているため、順番に実行することを推奨
- チェックポイントで問題が発生した場合は、前のタスクに戻って修正
